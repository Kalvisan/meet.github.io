<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Tik≈°anƒÅs uz kafiju</title>
  <style>
    :root{
      --bg1:#0a0a0a;
      --bg2:#1a1410;
      --accent:#e85c1a;
      --accent2:#ff6b35;
      --red:#c0392b;
      --glass: rgba(255,255,255,.10);
      --glass2: rgba(255,255,255,.18);
      --stroke: rgba(255,255,255,.22);
      --shadow: rgba(0,0,0,.45);
    }

    html,body{height:100%;margin:0;overflow:hidden;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{
      background:
        radial-gradient(1200px 700px at 20% 20%, rgba(232,92,26,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(255,107,53,.12), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(192,57,43,.08), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color:#fff;
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #wrap{position:relative;height:100%;width:100%;}
    canvas{position:absolute;inset:0;width:100%;height:100%;}

    .hud{
      position:absolute;
      left:0; right:0;
      top:0;
      display:flex;
      justify-content:space-between;
      padding: max(10px, env(safe-area-inset-top)) 12px 10px;
      pointer-events:none;
      gap:8px;
    }
    .tag{
      pointer-events:none;
      user-select:none;
      padding:8px 10px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      font-weight:700;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
      min-width: 64px;
      justify-content:center;
    }
    .dot{
      width:9px;height:9px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff, var(--accent));
      box-shadow: 0 0 16px rgba(232,92,26,.5);
    }
    .small{
      opacity:.88;
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }

    .center{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      pointer-events:none;
      width:min(520px, 92vw);
      text-align:center;
      padding: 0 10px;
    }
    @media (max-height: 500px){
      .center{
        top: 0;
        transform: translate(-50%, 0);
        padding-top: max(12px, env(safe-area-inset-top));
      }
    }

    .btn{
      pointer-events:auto;
      user-select:none;
      cursor:pointer;
      padding:14px 16px;
      border-radius:18px;
      --btn-progress: 0%;
      background-image:
        linear-gradient(90deg, rgba(232,92,26,.42) 0%, rgba(255,107,53,.35) var(--btn-progress), transparent var(--btn-progress)),
        linear-gradient(135deg, var(--glass), var(--glass2));
      background-size: 100% 100%;
      background-position: 0 0;
      border:1px solid rgba(255,255,255,.22);
      box-shadow:
        0 20px 50px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.22);
      backdrop-filter: blur(14px);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight:900;
      letter-spacing:.2px;
      font-size:16px;
      line-height: 1.15;
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
      touch-action: manipulation;
    }
    .btn:active{transform:translateZ(0) scale(.985);}

    .btn::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(180px 90px at 25% 20%, rgba(255,255,255,.25), transparent 55%),
                  radial-gradient(240px 120px at 80% 40%, rgba(232,92,26,.24), transparent 55%),
                  linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      opacity:.9;
      pointer-events:none;
    }
    .btn span{position:relative; z-index:1;}
    .btn .flame{width:18px;height:18px; position:relative; z-index:1; filter: drop-shadow(0 0 10px rgba(232,92,26,.45));}

    .sub{
      pointer-events:none;
      opacity:.84;
      font-weight:700;
      font-size:12.5px;
      line-height:1.35;
      padding:0 6px;
      text-shadow: 0 6px 18px rgba(0,0,0,.45);
    }

    .toast{
      position:absolute;
      left:50%;
      bottom: max(14px, env(safe-area-inset-bottom));
      transform:translateX(-50%);
      padding:12px 14px;
      border-radius:14px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 32px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      max-width: 92vw;
      text-overflow: ellipsis;
      overflow:hidden;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px);}

    .nametag{
      position:absolute;
      pointer-events:none;
      user-select:none;
      padding:4px 10px;
      border-radius:10px;
      background: rgba(0,0,0,.4);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(8px);
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
      transform:translate(-50%, -100%);
      margin-top:-36px;
      box-shadow: 0 4px 14px rgba(0,0,0,.3);
      z-index:5;
    }
    .floatFlames{position:absolute; inset:0; pointer-events:none; overflow:hidden; opacity:.55; mix-blend-mode: screen;}
    .ff{
      position:absolute;
      width:12px;height:14px;
      background: linear-gradient(180deg, rgba(255,200,80,.5) 0%, rgba(232,92,26,.4) 40%, rgba(192,57,43,.35) 100%);
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      filter: blur(.3px);
      animation: drift linear infinite;
    }
    @keyframes drift{
      from{transform:translateY(110vh) rotate(45deg) scale(.9); opacity:0;}
      10%{opacity:1;}
      90%{opacity:1;}
      to{transform:translateY(-20vh) rotate(45deg) scale(1.2); opacity:0;}
    }

    @media (min-width: 820px){
      .hud{padding: 16px 18px; gap:12px;}
      .tag{padding:10px 12px;}
      .small{font-size:13px;}
      .btn{font-size:16px; padding:14px 18px;}
      .sub{font-size:13px;}
      .toast{font-size:14px;}
    }

    .modal{
      position:fixed; inset:0;
      z-index:100;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: max(8px, env(safe-area-inset-top)) max(8px, env(safe-area-inset-right)) max(8px, env(safe-area-inset-bottom)) max(8px, env(safe-area-inset-left));
      opacity:0;
      pointer-events:none;
      transition: opacity .3s ease;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling: touch;
      box-sizing: border-box;
    }
    .modal.show{opacity:1; pointer-events:auto;}
    .modal-backdrop{
      position:absolute; inset:0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(10px);
    }
    .modal-content{
      position:relative;
      max-width: min(680px, calc(100vw - 16px));
      width: 100%;
      min-width: 0;
      max-height: min(90vh, 90dvh, 640px);
      margin: auto;
      padding: clamp(10px, 2.5vmin, 24px) clamp(12px, 3vmin, 24px);
      border-radius: clamp(12px, 3vmin, 24px);
      background: linear-gradient(165deg, #1a1410 0%, #0f0c0a 50%, #0a0806 100%);
      border: 2px solid rgba(232,92,26,.35);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.08) inset,
        0 28px 60px rgba(0,0,0,.55),
        0 0 80px rgba(255,77,166,.12);
      font-family: Georgia, "Times New Roman", serif;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      box-sizing: border-box;
    }
    .invitation-cols{
      display: grid;
      grid-template-columns: 1fr;
      gap: clamp(12px, 2.5vmin, 24px);
      align-items: start;
      text-align: center;
      min-width: 0;
    }
    @media (min-width: 480px){
      .invitation-cols{ grid-template-columns: 1fr 1fr; gap: clamp(14px, 3vmin, 28px); }
    }
    @media (min-width: 480px){
      .invitation-cols{ text-align: left; }
      .invitation-calendar{ text-align: left; }
      .invitation-greeting .invitation-body{ margin-left: 0; margin-right: 0; max-width: none; }
    }
    .invitation-greeting{ display: flex; flex-direction: column; gap: 0; min-width: 0; }
    .invitation-calendar{ display: flex; flex-direction: column; gap: clamp(8px, 1.5vmin, 14px); min-width: 0; }
    .invitation-calendar .invitation-dt-quick{ justify-content: flex-start; }
    @media (max-width: 479px){
      .invitation-calendar .invitation-dt-quick{ justify-content: center; }
    }
    .invitation-ornament{
      font-size: clamp(18px, 4.5vmin, 28px);
      letter-spacing: clamp(0.15em, 1.5vmin, 0.4em);
      color: var(--accent2);
      opacity: .9;
      margin-bottom: clamp(2px, 0.5vmin, 8px);
    }
    .invitation-label{
      font-size: clamp(9px, 2vmin, 11px);
      text-transform: uppercase;
      letter-spacing: .15em;
      color: rgba(255,255,255,.8);
      margin-bottom: clamp(6px, 1.2vmin, 14px);
      font-family: ui-sans-serif, system-ui, sans-serif;
    }
    .invitation-date{
      font-size: clamp(17px, 4.2vmin, 34px);
      font-weight: 700;
      color: #fff;
      margin: 0 0 clamp(8px, 2vmin, 24px);
      line-height: 1.2;
      text-shadow: 0 2px 12px rgba(0,0,0,.3);
    }
    .invitation-date span{ color: var(--accent2); }
    .invitation-body{
      font-size: clamp(12px, 2.6vmin, 16px);
      line-height: 1.5;
      color: rgba(255,255,255,.95);
      margin: 0 0 clamp(10px, 2vmin, 20px);
      max-width: min(320px, 100%);
      margin-left: auto;
      margin-right: auto;
    }
    .invitation-signature{
      font-size: clamp(12px, 2.5vmin, 16px);
      font-style: italic;
      color: var(--accent2);
      margin-bottom: 0;
    }
    .invitation-signature .name{ font-style: normal; font-weight: 700; }
    .invitation-datetime{
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: clamp(6px, 1.2vmin, 12px);
    }
    .invitation-dt-label{
      font-size: clamp(9px, 2vmin, 11px);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .06em;
      opacity: .9;
      color: rgba(255,255,255,.95);
    }
    .invitation-dt-quick{
      display: flex;
      flex-wrap: wrap;
      gap: clamp(6px, 1.2vmin, 10px);
      justify-content: center;
    }
    .invitation-dt-chip{
      padding: clamp(10px, 2vmin, 14px) clamp(12px, 2.5vmin, 18px);
      border-radius: clamp(10px, 2vmin, 14px);
      border: 2px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
      color: #fff;
      font-size: clamp(12px, 2.5vmin, 15px);
      font-weight: 700;
      cursor: pointer;
      transition: border-color .2s, background .2s;
      -webkit-tap-highlight-color: transparent;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    .invitation-dt-chip:hover, .invitation-dt-chip:focus{ border-color: var(--accent); background: rgba(232,92,26,.2); outline: none; }
    .invitation-dt-chip.active{ border-color: var(--accent); background: rgba(232,92,26,.35); box-shadow: 0 0 0 1px rgba(232,92,26,.3); }
    .invitation-dt-input{
      padding: clamp(10px, 2vmin, 14px) clamp(12px, 2.5vmin, 16px);
      border-radius: clamp(10px, 2vmin, 12px);
      border: 2px solid rgba(255,255,255,.25);
      background: rgba(0,0,0,.35);
      color: #fff;
      font-size: clamp(14px, 3.2vmin, 17px);
      min-height: 44px;
      box-sizing: border-box;
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
    }
    .invitation-dt-input:focus{ border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(232,92,26,.25); }
    .invitation-dt-input::-webkit-calendar-picker-indicator{ filter: invert(1); opacity: .8; cursor: pointer; padding: 4px; min-width: 28px; min-height: 28px; }
    .invitation-dt-custom{ display: flex; flex-direction: column; gap: clamp(4px, 1vmin, 8px); }
    .who-content{ max-width: min(380px, 92vw); color: #fff; font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; }
    .who-title{ margin: 0 0 20px; font-size: clamp(20px, 5vw, 26px); font-weight: 800; text-align: center; color: #fff; line-height: 1.3; text-shadow: 0 2px 8px rgba(0,0,0,.5); }
    .who-grid{ display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; justify-items: center; }
    .who-option{ cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 12px; border-radius: 14px; border: 2px solid rgba(255,255,255,.25); background: rgba(255,255,255,.1); transition: border-color .2s, background .2s; color: #fff; }
    .who-option:hover, .who-option:focus{ border-color: var(--accent); background: rgba(232,92,26,.2); outline: none; color: #fff; }
    .who-option img{ width: 64px; height: 64px; border-radius: 50%; object-fit: cover; }
    .who-option span{ font-weight: 700; font-size: clamp(14px, 3.5vw, 16px); text-align: center; color: #fff; text-shadow: 0 1px 4px rgba(0,0,0,.4); }
    .invitation-cols + .modal-close{
      margin-top: clamp(10px, 2vmin, 20px);
      width: 100%;
      min-height: 44px;
      box-sizing: border-box;
    }
    .modal-close{
      padding: clamp(12px, 2.5vmin, 20px) clamp(20px, 5vmin, 40px);
      border-radius: clamp(12px, 2.5vmin, 18px);
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 50%, #ff8c42 100%);
      border: 2px solid rgba(255,255,255,.35);
      color: #fff;
      font-weight: 900;
      font-size: clamp(14px, 3vmin, 18px);
      letter-spacing: .03em;
      cursor: pointer;
      font-family: inherit;
      box-shadow:
        0 0 0 1px rgba(0,0,0,.2) inset,
        0 12px 32px rgba(232,92,26,.5),
        0 4px 16px rgba(0,0,0,.35);
      text-shadow: 0 1px 2px rgba(0,0,0,.3);
      transition: transform .15s ease, box-shadow .2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .modal-close:hover{ box-shadow: 0 0 0 1px rgba(0,0,0,.2) inset, 0 14px 40px rgba(232,92,26,.55), 0 6px 20px rgba(0,0,0,.4); }
    .modal-close:active{ transform: scale(0.98); box-shadow: 0 8px 24px rgba(232,92,26,.45); }
    @media (max-height: 400px){
      .modal-content{ max-height: 98vh; max-height: 98dvh; padding: 8px 12px; overflow-y: auto; }
      .invitation-cols{ gap: 8px; }
      .invitation-ornament{ font-size: 16px; margin-bottom: 0; }
      .invitation-label{ margin-bottom: 4px; font-size: 8px; }
      .invitation-date{ font-size: 15px; margin-bottom: 4px; }
      .invitation-body{ font-size: 11px; margin-bottom: 6px; line-height: 1.4; }
      .invitation-signature{ font-size: 11px; margin-bottom: 0; }
      .invitation-datetime{ gap: 4px; }
      .invitation-dt-chip{ min-height: 38px; padding: 8px 12px; font-size: 11px; }
      .invitation-dt-input{ min-height: 38px; padding: 8px 10px; font-size: 13px; }
      .invitation-cols + .modal-close{ margin-top: 8px; min-height: 40px; padding: 10px 16px; font-size: 13px; }
    }
    @media (max-width: 360px){
      .modal-content{ padding: 10px 10px; max-width: calc(100vw - 8px); border-radius: 12px; }
      .invitation-ornament{ font-size: 16px; }
      .invitation-date{ font-size: 16px; }
      .invitation-dt-chip{ padding: 10px 12px; font-size: 12px; }
    }
    @media (min-width: 600px){
      .modal-content{ padding: clamp(16px, 3vmin, 28px); max-width: min(680px, calc(100vw - 24px)); }
    }

    .rotate-overlay{
      display:none;
      position:fixed; inset:0;
      z-index:1000;
      background: var(--bg2);
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:24px;
      padding:20px;
      text-align:center;
    }
    .rotate-overlay.show{ display:flex; }
    .rotate-overlay .icon{
      width:140px; height:80px;
      border:4px solid var(--accent);
      border-radius:20px;
      animation: rotateHint 2s ease-in-out infinite;
    }
    @keyframes rotateHint {
      0%, 100% { transform: rotate(-15deg); }
      50% { transform: rotate(75deg); }
    }
    .rotate-overlay p{
      margin:0;
      font-size:18px;
      font-weight:800;
      color:#fff;
      max-width:280px;
    }
    @media (prefers-reduced-motion: reduce){
      .ff{animation: none; opacity:.15;}
      .toast{transition:none;}
      .modal{transition:none;}
      .rotate-overlay .icon{ animation: none; transform: rotate(45deg); }
    }
  </style>
</head>
<body>
  <div id="rotateOverlay" class="rotate-overlay" aria-live="polite">
    <div class="icon" aria-hidden="true"></div>
    <p><br>Pagrieziet ekrƒÅnu, lai spƒìlƒìtu.</p>
  </div>
  <div id="wrap">
    <canvas id="world"></canvas>

    <div class="floatFlames" id="floatFlames"></div>

    <div class="modal" id="whoModal" role="dialog" aria-labelledby="whoModalTitle" aria-modal="true">
      <div class="modal-backdrop"></div>
      <div class="modal-content who-content">
        <h2 id="whoModalTitle" class="who-title">Kur≈° no cilvƒìkiem tu esi?</h2>
        <div class="who-grid" id="whoGrid"></div>
      </div>
    </div>
    <div class="modal" id="touchModal" role="dialog" aria-labelledby="modalTitle" aria-modal="true">
      <div class="modal-backdrop" id="modalBackdrop"></div>
      <div class="modal-content">
        <div class="invitation-cols">
          <div class="invitation-greeting">
            <p class="invitation-ornament" aria-hidden="true">‚òï? üçµ?</p>
            <p class="invitation-label">UzaicinƒÅjums tikties</p>
            <h2 id="modalTitle" class="invitation-date">Izvƒìlies sev ƒìrtƒÅko laiku</h2>
            <p class="invitation-body">
              Mƒìs vƒìlamies atkƒÅrtoti ar tevi tikties un parunƒÅties. Izvƒìlies sev vƒìlamƒÅko laiku, kad vƒìlies ar mums 1 stundu parunƒÅties (uz kafiju vai tƒìju).
            </p>
            <p class="invitation-signature">Lƒ´dz tik≈°anai, <span class="name">HoloKRAKEN</span></p>
          </div>
          <div class="invitation-calendar">
            <div class="invitation-datetime">
              <label class="invitation-dt-label">Datums</label>
              <div class="invitation-dt-quick" id="invitationDateQuick" role="group" aria-label="ƒÄtrƒÅ datuma izvƒìle">
                <button type="button" class="invitation-dt-chip active" data-days="7" id="dateChip7">Pƒìc nedƒìƒºas</button>
                <button type="button" class="invitation-dt-chip" data-days="14">Pƒìc 2 nedƒìƒºƒÅm</button>
              </div>
              <div class="invitation-dt-custom">
                <label class="invitation-dt-label" for="invitationDate">Vai izvƒìlies citu datumu</label>
                <input type="date" id="invitationDate" class="invitation-dt-input" min="" aria-label="Izvƒìlies datumu">
              </div>
              <label class="invitation-dt-label" for="invitationTime">Laiks (sƒÅkums, 1h)</label>
              <select id="invitationTime" class="invitation-dt-input" aria-label="Izvƒìlies laiku"></select>
            </div>
          </div>
        </div>
        <button type="button" class="modal-close" id="modalClose">Pie≈Üemu uzaicinƒÅjumu</button>
      </div>
    </div>

    <div class="nametag" id="nametagYou" aria-hidden="true"></div>
    <div class="nametag" id="nametagHer" aria-hidden="true"></div>

    <div class="center">
      <button id="cta" class="btn" aria-label="Spied">
        <svg class="flame" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 23c-1.5-1-4-3.5-4-6 0-2 1.5-3 3-3s3 1 3 3c0 2.5-2.5 5-4 6zm0-21c2 2 5 5 5 10 0 4-3 7-5 7s-5-3-5-7c0-5 3-8 5-10z" fill="rgba(232,92,26,.95)"/>
        </svg>
        <span>Nospied pogu, lai mƒìs satiktos.</span>
      </button>
    </div>

    <div class="toast" id="toast" aria-live="polite">Lieliski! Tiksimies! ‚òïüî•</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
  <script>
    (async () => {
      const overlay = document.getElementById('rotateOverlay');
      const whoModal = document.getElementById('whoModal');
      const whoGrid = document.getElementById('whoGrid');
      const isLandscape = () => window.innerWidth >= window.innerHeight;

      const PLACEHOLDER_IMG = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><circle cx="32" cy="32" r="30" fill="#444"/></svg>');
      function personImageSrc(val) {
        if (!val || !val.trim()) return PLACEHOLDER_IMG;
        const s = val.trim();
        if (s.startsWith('data:')) return s;
        if (s.startsWith('http://') || s.startsWith('https://') || s.startsWith('./') || /\.(png|jpg|jpeg|gif|webp)$/i.test(s)) return s;
        return 'data:image/png;base64,' + s;
      }
      function showWhoModal() {
        whoModal.classList.add('show');
        whoGrid.innerHTML = '';
        PEOPLE.forEach((person) => {
          const opt = document.createElement('button');
          opt.type = 'button';
          opt.className = 'who-option';
          const img = document.createElement('img');
          img.alt = '';
          img.src = personImageSrc(person.imageBase64 || person.imageUrl || '');
          img.onerror = () => { img.src = PLACEHOLDER_IMG; };
          const span = document.createElement('span');
          span.textContent = person.name;
          opt.appendChild(img);
          opt.appendChild(span);
          opt.addEventListener('click', () => {
            whoModal.classList.remove('show');
            runGame(person);
          });
          whoGrid.appendChild(opt);
        });
      }

      // Cilvƒìku saraksts: vƒÅrds + sejas attƒìls (base64). Pievieno savus.
      const PEOPLE = [
        { name: 'Kristaps', imageBase64: 'https://meet.holokraken.com/Kristaps.png' },
        { name: 'Egita', imageBase64: 'https://meet.holokraken.com/Egita.png' },
        { name: 'MƒÅrti≈Ü≈°', imageBase64: 'https://meet.holokraken.com/Martins.png' }
      ];
      // OtrƒÅ persona spƒìlƒì (komanda / "mƒìs") ‚Äî fiksƒìts
      const HER_NAME = 'Kalvis';

      const runGame = async (selectedPerson) => {
      const MY_NAME = selectedPerson ? selectedPerson.name : (PEOPLE[0] && PEOPLE[0].name) || 'Tu';
      const { Engine, Render, Runner, World, Bodies, Body, Constraint, Composite, Events, Vector } = Matter;

      // ---------- Sejas kƒÅ PNG base64 (aizvieto ragdoll galvƒÅm) ----------
      // Ieliec ≈°eit base64 PNG (piem. no https://www.base64-image.de/ vai "data:image/png;base64,..." kopƒìjot no pƒÅrl≈´ka).
      // IdeƒÅli ~256√ó256 px. Ja tuk≈°i ‚Äì tiks rƒÅdƒ´ts vienkƒÅr≈°s aplis.
      const FACE_ME = 'https://meet.holokraken.com/Kalvis.png';

      const canvas = document.getElementById('world');
      const engine = Engine.create();
      engine.gravity.y = 1.05;
      engine.constraintIterations = 8;

      const render = Render.create({
        canvas,
        engine,
        options: {
          width: window.innerWidth,
          height: window.innerHeight,
          wireframes: false,
          background: 'transparent',
          pixelRatio: Math.min(window.devicePixelRatio || 1, 2)
        }
      });

      const runner = Runner.create();
      Runner.run(runner, engine);
      Render.run(render);

      // Mobile: prevent scroll/bounce/gesture zoom while playing
      document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
      document.addEventListener('gesturestart', (e) => e.preventDefault());
      document.body.style.webkitUserSelect = 'none';
      document.body.style.webkitTouchCallout = 'none';

      // ---------- Helpers ----------

      // Matter.js 0.19.0 doesn't have Bodies.roundedRect.
      // Use Bodies.rectangle + chamfer radius to get rounded corners.
      function roundedRect(x, y, w, h, r, opts) {
        const radius = Math.max(0, Math.min(r || 0, Math.min(w, h) / 2));
        const o = opts ? { ...opts } : {};
        // preserve existing chamfer if provided
        if (!o.chamfer && radius > 0) o.chamfer = { radius };
        return Bodies.rectangle(x, y, w, h, o);
      }

      function assert(cond, msg) {
        if (!cond) throw new Error('TEST FAILED: ' + msg);
      }

      function runSmokeTests() {
        // Test 1: roundedRect helper exists and returns a body
        const b = roundedRect(100, 100, 40, 20, 6, { isStatic: true });
        assert(b && b.vertices && b.vertices.length >= 4, 'roundedRect should return a valid body');

        // Test 2: Matter version loaded
        assert(typeof Matter !== 'undefined' && typeof Bodies.rectangle === 'function', 'Matter.js should be loaded');

        // Test 3: Ensure we are not relying on Bodies.roundedRect
        assert(typeof Bodies.roundedRect === 'undefined', 'Bodies.roundedRect should not be required');

        console.log('[OK] Smoke tests passed');
      }

      runSmokeTests();

      // ---------- World / bounds ----------

      let W = render.options.width, H = render.options.height;
      const wallThickness = 120;
      const FLOOR_WIDTH = 500000; // "bezgalƒ´ga" grƒ´da

      let walls = [];
      let cushion = null;

      function buildBounds() {
        if (walls.length) World.remove(engine.world, walls);
        if (cushion) World.remove(engine.world, cushion);

        const floorY = H + wallThickness / 2;
        walls = [
          Bodies.rectangle(W/2, -wallThickness/2, W + 2*wallThickness, wallThickness, { isStatic:true, render:{ visible:false } }),
          Bodies.rectangle(W/2, floorY, FLOOR_WIDTH, wallThickness, { isStatic:true, friction: 0.9, frictionStatic: 1, render:{ visible:false } }),
          Bodies.rectangle(-wallThickness/2, H/2, wallThickness, H + 2*wallThickness, { isStatic:true, render:{ visible:false } }),
          Bodies.rectangle(W + wallThickness/2, H/2, wallThickness, H + 2*wallThickness, { isStatic:true, render:{ visible:false } }),
        ];
        World.add(engine.world, walls);

        const cushionTop = H - 28;
        cushion = Bodies.rectangle(W/2, cushionTop + 14, FLOOR_WIDTH, 28, {
          isStatic: true,
          friction: 0.9,
          frictionStatic: 1,
          render: { fillStyle: 'rgba(255,255,255,.06)', strokeStyle: 'rgba(255,255,255,.12)', lineWidth: 1 }
        });
        World.add(engine.world, cushion);
      }

      buildBounds();

      // ---------- Seju tekst≈´ras (base64 PNG, apƒºveida maska galvai) ----------

      function makePlaceholderFace() {
        const c = document.createElement('canvas');
        c.width = 256; c.height = 256;
        const g = c.getContext('2d');
        g.save();
        g.translate(128, 128);
        g.scale(0.75, 1);
        g.fillStyle = 'rgba(255,200,220,.9)';
        g.beginPath(); g.arc(0, 0, 118, 0, Math.PI*2); g.fill();
        g.strokeStyle = 'rgba(255,255,255,.4)';
        g.lineWidth = 4;
        g.stroke();
        g.restore();
        return c.toDataURL('image/png');
      }

      /** IelƒÅdƒì attƒìlu (data URL vai parasts URL) un uzklƒÅj ovƒÅlu masku. Atgrie≈æ data URL. */
      function applyOvalMaskToFace(src) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          if (!src.startsWith('data:')) img.crossOrigin = 'anonymous';
          img.onload = () => {
            const c = document.createElement('canvas');
            c.width = 256;
            c.height = 256;
            const g = c.getContext('2d');
            g.save();
            g.translate(128, 128);
            g.scale(0.75, 1);
            g.arc(0, 0, 118, 0, Math.PI * 2);
            g.closePath();
            g.clip();
            g.setTransform(1, 0, 0, 1, 0, 0);
            g.drawImage(img, 0, 0, 256, 256);
            g.restore();
            resolve(c.toDataURL('image/png'));
          };
          img.onerror = () => reject(new Error('NeizdevƒÅs ielƒÅdƒìt sejas attƒìlu'));
          img.src = src;
        });
      }

      /** Atbalsta gan base64, gan parastu URL (http/https vai relatƒ´vs ceƒº≈°, piem. "Kalvis.png"). */
      async function getFaceTexture(source) {
        const s = (typeof source === 'string' && source.trim()) ? source.trim() : '';
        if (!s) return makePlaceholderFace();
        if (s.startsWith('data:')) return applyOvalMaskToFace(s);
        if (s.startsWith('http://') || s.startsWith('https://') || s.startsWith('./') || /^[a-zA-Z0-9_\-]+\.(png|jpg|jpeg|gif|webp)$/i.test(s)) return applyOvalMaskToFace(s);
        return applyOvalMaskToFace('data:image/png;base64,' + s);
      }

      const faceYou = await getFaceTexture(selectedPerson && selectedPerson.imageBase64 ? selectedPerson.imageBase64 : '');
      const faceHer = await getFaceTexture(FACE_ME);

      // ---------- Ragdoll builder ----------

      function makeRagdoll(x, y, scale, faceTexture, tint) {
        const skin = { friction: 0.65, frictionStatic: 0.8, restitution: 0.06, frictionAir: 0.02, density: 0.0012 };
        const limb = { friction: 0.65, frictionStatic: 0.8, restitution: 0.05, frictionAir: 0.025, density: 0.0010 };

        const headRadiusX = 24*scale, headRadiusY = 32*scale;
        const headVerts = [];
        for (let i = 0; i < 24; i++) {
          const t = (i / 24) * Math.PI * 2;
          headVerts.push({ x: headRadiusX * Math.cos(t), y: headRadiusY * Math.sin(t) });
        }
        const head = Bodies.fromVertices(x, y - 90*scale, headVerts, {
          ...skin,
          label: 'head',
          render: { sprite: { texture: faceTexture, xScale: (2*headRadiusX)/256, yScale: (2*headRadiusY)/256 } }
        });

        const torso = roundedRect(x, y - 30*scale, 54*scale, 72*scale, 18*scale, {
          ...skin,
          label: 'torso',
          render: { fillStyle: tint, strokeStyle: 'rgba(255,255,255,.25)', lineWidth: 2 }
        });

        const hip = roundedRect(x, y + 25*scale, 54*scale, 34*scale, 14*scale, {
          ...skin,
          label: 'hip',
          render: { fillStyle: tint, strokeStyle: 'rgba(255,255,255,.22)', lineWidth: 2 }
        });

        const upperArmL = roundedRect(x - 45*scale, y - 45*scale, 18*scale, 46*scale, 9*scale, {
          ...limb, render:{ fillStyle:'rgba(255,255,255,.10)', strokeStyle:'rgba(255,255,255,.20)', lineWidth:2 }
        });
        const lowerArmL = roundedRect(x - 55*scale, y - 5*scale, 16*scale, 46*scale, 8*scale, {
          ...limb, render:{ fillStyle:'rgba(255,255,255,.10)', strokeStyle:'rgba(255,255,255,.20)', lineWidth:2 }
        });

        const upperArmR = roundedRect(x + 45*scale, y - 45*scale, 18*scale, 46*scale, 9*scale, {
          ...limb, render:{ fillStyle:'rgba(255,255,255,.10)', strokeStyle:'rgba(255,255,255,.20)', lineWidth:2 }
        });
        const lowerArmR = roundedRect(x + 55*scale, y - 5*scale, 16*scale, 46*scale, 8*scale, {
          ...limb, render:{ fillStyle:'rgba(255,255,255,.10)', strokeStyle:'rgba(255,255,255,.20)', lineWidth:2 }
        });

        const upperLegL = roundedRect(x - 18*scale, y + 75*scale, 20*scale, 52*scale, 10*scale, {
          ...limb, render:{ fillStyle:'rgba(255,255,255,.08)', strokeStyle:'rgba(255,255,255,.18)', lineWidth:2 }
        });
        const lowerLegL = roundedRect(x - 18*scale, y + 125*scale, 18*scale, 52*scale, 9*scale, {
          ...limb, render:{ fillStyle:'rgba(255,255,255,.08)', strokeStyle:'rgba(255,255,255,.18)', lineWidth:2 }
        });

        const upperLegR = roundedRect(x + 18*scale, y + 75*scale, 20*scale, 52*scale, 10*scale, {
          ...limb, render:{ fillStyle:'rgba(255,255,255,.08)', strokeStyle:'rgba(255,255,255,.18)', lineWidth:2 }
        });
        const lowerLegR = roundedRect(x + 18*scale, y + 125*scale, 18*scale, 52*scale, 9*scale, {
          ...limb, render:{ fillStyle:'rgba(255,255,255,.08)', strokeStyle:'rgba(255,255,255,.18)', lineWidth:2 }
        });

        const c = (a, b, ax, ay, bx, by, stiffness, length=0) =>
          Constraint.create({
            bodyA: a, bodyB: b,
            pointA: {x: ax*scale, y: ay*scale},
            pointB: {x: bx*scale, y: by*scale},
            stiffness: Math.min(stiffness, 0.85),
            length,
            render: { visible:false }
          });

        const constraints = [
          c(head, torso, 0, headRadiusY * 0.7, 0, -36, 0.76),
          c(torso, hip, 0, 36, 0, -16, 0.78),

          c(torso, upperArmL, -28, -26, 0, -22, 0.7),
          c(upperArmL, lowerArmL, 0, 22, 0, -22, 0.7),
          c(torso, upperArmR, 28, -26, 0, -22, 0.7),
          c(upperArmR, lowerArmR, 0, 22, 0, -22, 0.7),

          c(hip, upperLegL, -14, 16, 0, -24, 0.76),
          c(upperLegL, lowerLegL, 0, 24, 0, -24, 0.76),
          c(hip, upperLegR, 14, 16, 0, -24, 0.76),
          c(upperLegR, lowerLegR, 0, 24, 0, -24, 0.76),
        ];

        const bodies = [head, torso, hip, upperArmL, lowerArmL, upperArmR, lowerArmR, upperLegL, lowerLegL, upperLegR, lowerLegR];

        bodies.forEach((b) => {
          Body.setAngle(b, (Math.random()-0.5) * 0.08);
          Body.setAngularVelocity(b, (Math.random()-0.5) * 0.03);
        });

        const composite = Composite.create({ label: 'ragdoll' });
        Composite.add(composite, bodies);
        Composite.add(composite, constraints);
        return { composite, head, torso, hip, bodies };
      }

      const scale = Math.min(Math.max(Math.min(W,H)/980, 0.78), 1.15);
      const feetOffset = 151 * scale;
      const cushionTopY = H - 28;
      const standHeightOffset = 14;
      const ragdollCenterY = cushionTopY - feetOffset - standHeightOffset;
      const left = makeRagdoll(W*0.25, ragdollCenterY, scale, faceYou, 'rgba(232,92,26,.22)');
      const right = makeRagdoll(W*0.75, ragdollCenterY, scale, faceHer, 'rgba(255,107,53,.22)');
      World.add(engine.world, [left.composite, right.composite]);

      // Nametagi virs cilvƒìci≈Üiem
      const nametagYou = document.getElementById('nametagYou');
      const nametagHer = document.getElementById('nametagHer');
      nametagYou.textContent = MY_NAME;
      nametagHer.textContent = HER_NAME;

      // ---------- Background hearts (DOM) ----------

      const floatFlames = document.getElementById('floatFlames');
      const isMobile = () => Math.min(window.innerWidth, window.innerHeight) < 640;
      const flameCount = isMobile() ? 14 : 22;
      for (let i=0;i<flameCount;i++){
        const el = document.createElement('div');
        el.className = 'ff';
        el.style.left = (Math.random()*100) + 'vw';
        el.style.animationDuration = (7 + Math.random()*10) + 's';
        el.style.animationDelay = (-Math.random()*10) + 's';
        el.style.transform = `translateY(${Math.random()*100}vh) rotate(45deg) scale(${0.7+Math.random()*1.0})`;
        el.style.opacity = (0.25+Math.random()*0.55);
        floatFlames.appendChild(el);
      }

      // ---------- CTA / behavior ----------

      const cta = document.getElementById('cta');
      const ctaSpan = cta.querySelector('span');
      const toast = document.getElementById('toast');
      const touchModal = document.getElementById('touchModal');
      const modalClose = document.getElementById('modalClose');
      const modalBackdrop = document.getElementById('modalBackdrop');
      let closeness = 0;
      let hasCelebrated = false;
      let hasTouched = false;

      const CLICK_WINDOW_MS = 3000;
      const CTA_TEXT_MIN_MS = 1500;
      let clickTimestamps = [];
      let lastCtaTextChangeTime = 0;
      let currentProgress = 0;
      let lastProgressBucket = -1;
      let lastCpsBucket = -1;

      // 2D matrica: [progressBucket][cpsBucket]
      // progressBucket: 0 = tƒÅlu (0‚Äì33%), 1 = vidƒìji (33‚Äì66%), 2 = tuvu (66‚Äì100%)
      // cpsBucket: 0 = zems (<0.5/s), 1 = vidƒìjs (0.5‚Äì1/s), 2 = augsts (‚â•1/s)
      const TEXTS_MATRIX = [
        [
          'Nospied pogu, lai mƒìs satiktos.',
          'Spied vairƒÅk reizes pƒìc kƒÅrtas ‚Äì vi≈Üi tuvosies.',
          'Vi≈Üi vƒìl tƒÅlu ‚Äì spied vƒìl!'
        ],
        [
          'Spied bie≈æƒÅk ‚Äì tad vi≈Üi ƒÅtrƒÅk tuvotos.',
          'Vi≈Üi iet viens otram pretƒ´ ‚Äì turpini spaidƒ´t!',
          'Lieliski! Vi≈Üi jau pusceƒºƒÅ.'
        ],
        [
          'PƒÅrƒÅk lƒìnu spaidi ‚Äì vi≈Üi ir tik tuvu!',
          'Turpini tik pat ƒÅtri spaidƒ´t ‚Äì vƒìl pƒÅris spiedieni!',
          'Turpini tƒÅ ‚Äì gandrƒ´z jau ir!'
        ]
      ];

      function freezeRagdolls() {
        Composite.allBodies(left.composite).forEach((b) => Body.setStatic(b, true));
        Composite.allBodies(right.composite).forEach((b) => Body.setStatic(b, true));
      }

      function showTouchModal() {
        fillInvitationDateTime();
        touchModal.classList.add('show');
      }

      function hideTouchModal() {
        touchModal.classList.remove('show');
      }

      const CALENDAR_BASE = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
      const CALENDAR_EMAILS = '&add=kalvis@kalmars.lv,maris@kalmars.lv';
      function buildCalendarUrl() {
        const d = document.getElementById('invitationDate').value;
        const t = document.getElementById('invitationTime').value;
        if (!d || !t) return CALENDAR_BASE + '&text=Tik≈°anƒÅs+ar+HoloKRAKEN&details=Tik≈°anƒÅs+ar+HoloKRAKEN+uz+kafiju&dates=20260214T100000/20260214T110000' + CALENDAR_EMAILS;
        const [year, month, day] = d.split('-').map(Number);
        const startHour = parseInt(t, 10);
        const endHour = startHour + 1;
        const pad = n => String(n).padStart(2, '0');
        const start = `${year}${pad(month)}${pad(day)}T${pad(startHour)}0000`;
        const nextDay = new Date(year, month - 1, day + 1);
        const end = endHour >= 24
          ? `${nextDay.getFullYear()}${pad(nextDay.getMonth()+1)}${pad(nextDay.getDate())}T000000`
          : `${year}${pad(month)}${pad(day)}T${pad(endHour)}0000`;
        const text = encodeURIComponent('Tik≈°anƒÅs uz kafiju');
        const details = encodeURIComponent('1h saruna ar HoloKRAKEN');
        return `${CALENDAR_BASE}&text=${text}&details=${details}&dates=${start}/${end}${CALENDAR_EMAILS}`;
      }
      function formatDateForInput(d) {
        const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0');
        return y + '-' + m + '-' + day;
      }
      function fillInvitationDateTime() {
        const dateEl = document.getElementById('invitationDate');
        const timeEl = document.getElementById('invitationTime');
        const today = new Date();
        const minDate = new Date(today);
        minDate.setDate(minDate.getDate() + 1);
        dateEl.min = formatDateForInput(minDate);
        const defaultDate = new Date(today);
        defaultDate.setDate(defaultDate.getDate() + 7);
        dateEl.value = formatDateForInput(defaultDate);

        const chips = document.querySelectorAll('.invitation-dt-chip[data-days]');
        function setDateFromDays(days) {
          const d = new Date(today);
          d.setDate(d.getDate() + days);
          dateEl.value = formatDateForInput(d);
          chips.forEach(c => c.classList.toggle('active', parseInt(c.getAttribute('data-days'), 10) === days));
        }
        function updateChipsFromInput() {
          const val = dateEl.value;
          if (!val) return;
          const selected = new Date(val + 'T12:00:00');
          const daysDiff = Math.round((selected - today) / (24 * 60 * 60 * 1000));
          chips.forEach(c => {
            const d = parseInt(c.getAttribute('data-days'), 10);
            c.classList.toggle('active', d === daysDiff);
          });
        }
        if (!dateEl.dataset.dateInit) {
          dateEl.dataset.dateInit = '1';
          chips.forEach(c => {
            c.addEventListener('click', () => setDateFromDays(parseInt(c.getAttribute('data-days'), 10)));
          });
          dateEl.addEventListener('change', updateChipsFromInput);
          dateEl.addEventListener('input', updateChipsFromInput);
        }
        updateChipsFromInput();

        timeEl.innerHTML = '';
        for (let h = 9; h <= 20; h++) {
          const opt = document.createElement('option');
          opt.value = h;
          opt.textContent = (h < 10 ? '0' : '') + h + ':00 ‚Äì ' + (h + 1) + ':00';
          timeEl.appendChild(opt);
        }
      }
      modalClose.addEventListener('click', () => {
        window.open(buildCalendarUrl(), '_blank', 'noopener,noreferrer');
        hideTouchModal();
      });

      // StaigƒÅ≈°ana: katrs lƒìnƒÅm iet uz savu pusi; poga 0.5s ‚Äî iet viens otram pretƒ´
      const WALK_FORCE = 0.00085;
      let walkTowardEachOtherUntil = 0;
      function isWalkingTowardEachOther() { return Date.now() < walkTowardEachOtherUntil; }

      function applyWalkForces() {
        const toward = isWalkingTowardEachOther();
        const leftDir = toward ? 1 : -1;
        const rightDir = toward ? -1 : 1;
        Body.applyForce(left.torso, left.torso.position, { x: leftDir * WALK_FORCE, y: 0 });
        Body.applyForce(right.torso, right.torso.position, { x: rightDir * WALK_FORCE, y: 0 });
      }

      function nudgeTowardCenter() {
        const centerX = W/2;
        closeness = Math.min(closeness + 0.1, 3.2);
        const forceMag = 0.001 * (0.5 + closeness);

        walkTowardEachOtherUntil = Date.now() + 500;
        applyNudge(left);
        applyNudge(right);

        if (Math.random() < 0.5) {
          Body.applyForce(left.torso, left.torso.position, { x: 0, y: -0.0006*(0.5+Math.random()) });
          Body.applyForce(right.torso, right.torso.position, { x: 0, y: -0.0006*(0.5+Math.random()) });
        }

        const wob = (Math.random()*2-1) * 2;
        cta.style.transform = `translateZ(0) rotate(${wob}deg)`;
        setTimeout(() => cta.style.transform = 'translateZ(0)', 90);

        function applyNudge(r) {
          const dx = centerX - r.torso.position.x;
          const dir = Math.sign(dx) || 1;
          const force = { x: dir * forceMag, y: 0 };
          Body.applyForce(r.torso, r.torso.position, force);
          Body.applyForce(r.head, r.head.position, { x: force.x * 0.5, y: force.y });
        }
      }

      const fx = document.createElement('canvas');
      fx.style.position = 'absolute';
      fx.style.inset = '0';
      fx.style.pointerEvents = 'none';
      fx.width = W; fx.height = H;
      document.getElementById('wrap').appendChild(fx);
      const fctx = fx.getContext('2d');

      let particles = [];
      function spawnFlamesBurst(x, y, count) {
        for (let i=0;i<count;i++){
          const a = Math.random()*Math.PI*2;
          const sp = 2.0 + Math.random()*5.2;
          particles.push({
            x, y,
            vx: Math.cos(a)*sp + (Math.random()*1.2-0.6),
            vy: Math.sin(a)*sp - (3.4 + Math.random()*2.6),
            rot: Math.random()*Math.PI*2,
            vr: (Math.random()*2-1)*0.18,
            s: 0.55 + Math.random()*1.25,
            life: 1.0,
            hue: (Math.random() < 0.7 ? 25 : 15) + (Math.random()*20-10)
          });
        }
      }

      function celebrate(p) {
        hasCelebrated = true;
        const target = { x: W/2, y: H*0.58 };
        const tug = (r) => {
          const dir = Vector.normalise(Vector.sub(target, r.torso.position));
          Body.applyForce(r.torso, r.torso.position, { x: dir.x*0.012, y: dir.y*0.012 });
          Body.applyForce(r.head, r.head.position, { x: dir.x*0.008, y: dir.y*0.008 });
          Body.setAngularVelocity(r.torso, (Math.random()*2-1)*0.2);
        };
        tug(left); tug(right);

        const big = isMobile() ? 90 : 140;
        spawnFlamesBurst(p.x, p.y, big);
        setTimeout(() => spawnFlamesBurst(W/2, H*0.45, Math.round(big*0.5)), 120);
        setTimeout(() => spawnFlamesBurst(W/2, H*0.42, Math.round(big*0.4)), 260);

        if (toast) {
          toast.classList.add('show');
          setTimeout(() => toast.classList.remove('show'), 2600);
        }
        const span = cta ? cta.querySelector('span') : null;
        if (span) span.textContent = 'Tiekamies! üíû';
      }

      function drawFlame(ctx, x, y, s, rot, fill) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(rot);
        ctx.scale(s, s);
        ctx.beginPath();
        ctx.moveTo(0, -12);
        ctx.bezierCurveTo(-6, -4, -8, 6, 0, 12);
        ctx.bezierCurveTo(4, 4, 6, -2, 0, -12);
        ctx.closePath();
        ctx.fillStyle = fill;
        ctx.fill();
        ctx.restore();
      }

      function fxTick() {
        // Nametagi virs galvƒÅm (world koordinƒÅtas = pikseƒºi)
        const headYou = left.head.position;
        const headHer = right.head.position;
        nametagYou.style.left = headYou.x + 'px';
        nametagYou.style.top = headYou.y + 'px';
        nametagHer.style.left = headHer.x + 'px';
        nametagHer.style.top = headHer.y + 'px';

        // 0% = max attƒÅlums (ekrƒÅna platums W), 100% = saskaras vai "Yess"
        let progress;
        if (hasCelebrated) {
          progress = 1;
        } else {
          const dist = Vector.magnitude(Vector.sub(right.torso.position, left.torso.position));
          progress = Math.max(0, Math.min(1, 1 - dist / Math.max(W, 1)));
        }
        currentProgress = progress;
        cta.style.setProperty('--btn-progress', (progress * 100) + '%');

        updateCtaTextFromClicks();

        fctx.clearRect(0,0,fx.width,fx.height);
        fctx.globalCompositeOperation = 'lighter';

        particles = particles.filter(pt => pt.life > 0);
        for (const pt of particles) {
          pt.life -= 0.014;
          pt.vy += 0.10;
          pt.x += pt.vx;
          pt.y += pt.vy;
          pt.rot += pt.vr;

          const alpha = Math.max(pt.life, 0);
          const fill = `hsla(${pt.hue}, 95%, 65%, ${alpha})`;

          fctx.shadowBlur = 18;
          fctx.shadowColor = `hsla(${pt.hue}, 95%, 65%, ${alpha*0.7})`;
          drawFlame(fctx, pt.x, pt.y, pt.s, pt.rot, fill);
        }

        fctx.shadowBlur = 0;
        fctx.globalCompositeOperation = 'source-over';
        requestAnimationFrame(fxTick);
      }
      fxTick();

      function updateCtaTextFromClicks() {
        if (hasCelebrated) return;
        const now = Date.now();
        clickTimestamps = clickTimestamps.filter((t) => now - t < CLICK_WINDOW_MS);
        const cps = clickTimestamps.length / (CLICK_WINDOW_MS / 1000);
        const progressBucket = currentProgress < 0.34 ? 0 : currentProgress < 0.67 ? 1 : 2;
        const cpsBucket = cps < 0.5 ? 0 : cps < 1 ? 1 : 2;
        const bucketChanged = progressBucket !== lastProgressBucket || cpsBucket !== lastCpsBucket;
        if (!bucketChanged) return;
        const isFirstUpdate = lastProgressBucket === -1;
        if (!isFirstUpdate && now - lastCtaTextChangeTime < CTA_TEXT_MIN_MS) return;
        lastProgressBucket = progressBucket;
        lastCpsBucket = cpsBucket;
        lastCtaTextChangeTime = now;
        const row = TEXTS_MATRIX[progressBucket];
        const text = row[cpsBucket];
        ctaSpan.textContent = text;
        // console.log('[CTA] clicks/s:', cps.toFixed(2), '| progressBucket:', progressBucket, '| cpsBucket:', cpsBucket, '| teksts:', text);
      }

      const press = (e) => {
        e.preventDefault();
        if (hasCelebrated) {
          nudgeTowardCenter();
          spawnFlamesBurst(W/2, H*0.45, isMobile() ? 12 : 18);
          return;
        }
        clickTimestamps.push(Date.now());
        updateCtaTextFromClicks();
        nudgeTowardCenter();
      };
      cta.addEventListener('pointerdown', press, { passive: false });

      Events.on(engine, 'collisionStart', (evt) => {
        for (const pair of evt.pairs) {
          const a = pair.bodyA, b = pair.bodyB;
          const inLeft = isInComposite(a, left.composite) || isInComposite(b, left.composite);
          const inRight = isInComposite(a, right.composite) || isInComposite(b, right.composite);
          if (inLeft && inRight) {
            if (!hasTouched) {
              hasTouched = true;
              freezeRagdolls();
              showTouchModal();
            }
            if (!hasCelebrated) {
              hasCelebrated = true;
              celebrate(pair.collision.supports[0] || { x: W/2, y: H/2 });
            }
            break;
          }
        }
      });

      function isInComposite(body, composite) {
        return Composite.allBodies(composite).includes(body);
      }

      // Mƒ´kstƒÅka korekcija ‚Äî mazƒÅk raustƒ´≈°anƒÅs; le≈Üƒ∑iskais ƒÅtrums lƒìnƒÅm virzƒÅs pret stƒÅvu.
      const STAND_GAIN = 0.2;
      const STAND_BLEND = 0.1;
      const DAMP_BLEND = 0.94;
      const LIFT_PER_RAD = 0.005;
      const LIFT_MIN_ANGLE = 0.12;
      const LEG_BLEND = 0.06;

      function tryToStand(ragdoll) {
        const torso = ragdoll.torso;
        const hip = ragdoll.hip;
        let angle = torso.angle;
        while (angle > Math.PI) angle -= Math.PI * 2;
        while (angle < -Math.PI) angle += Math.PI * 2;
        const absAngle = Math.abs(angle);
        const av = torso.angularVelocity;

        const desiredAv = -angle * STAND_GAIN;
        Body.setAngularVelocity(torso, av * DAMP_BLEND + desiredAv * STAND_BLEND);

        let hipA = hip.angle;
        while (hipA > Math.PI) hipA -= Math.PI * 2;
        while (hipA < -Math.PI) hipA += Math.PI * 2;
        Body.setAngularVelocity(hip, hip.angularVelocity * DAMP_BLEND + (-hipA * STAND_GAIN * 0.45) * STAND_BLEND);

        const legIndices = [7, 8, 9, 10];
        legIndices.forEach((i) => {
          const leg = ragdoll.bodies[i];
          let la = leg.angle;
          while (la > Math.PI) la -= Math.PI * 2;
          while (la < -Math.PI) la += Math.PI * 2;
          Body.setAngularVelocity(leg, leg.angularVelocity * DAMP_BLEND + (-la * STAND_GAIN * 0.4) * LEG_BLEND);
        });

        if (absAngle > LIFT_MIN_ANGLE) {
          const lift = LIFT_PER_RAD * Math.min(absAngle, 1.5);
          Body.applyForce(torso, torso.position, { x: 0, y: -lift });
          Body.applyForce(ragdoll.head, ragdoll.head.position, { x: 0, y: -lift * 0.45 });
        }
      }

      left.scale = right.scale = scale;

      Events.on(engine, 'beforeUpdate', () => {
        if (hasTouched) return;
        tryToStand(left);
        tryToStand(right);
        applyWalkForces();
      });

      setInterval(() => {
        if (!hasCelebrated && Math.random() < 0.25) {
          const f = 0.0003;
          Body.applyForce(left.torso, left.torso.position, { x: 0, y: -Math.random()*f });
          Body.applyForce(right.torso, right.torso.position, { x: 0, y: -Math.random()*f });
        }
      }, 600);

      function onResize(){
        W = window.innerWidth; H = window.innerHeight;

        // update renderer
        render.options.width = W; render.options.height = H;
        Render.setPixelRatio(render, Math.min(window.devicePixelRatio || 1, 2));
        Render.setSize(render, W, H);

        // update fx
        fx.width = W; fx.height = H;

        // rebuild static bounds sized to new viewport
        buildBounds();
      }
      window.addEventListener('resize', onResize);

      window.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
          e.preventDefault();
          cta.dispatchEvent(new PointerEvent('pointerdown', { bubbles:true }));
        }
      });

      async function loadTexture(url){
        const img = new Image();
        img.crossOrigin = 'anonymous';
        return await new Promise((res, rej) => {
          img.onload = () => res(url);
          img.onerror = rej;
          img.src = url;
        });
      }

      };

      if (!isLandscape()) {
        overlay.classList.add('show');
        const startWhenLandscape = () => {
          if (!isLandscape()) return;
          overlay.classList.remove('show');
          window.removeEventListener('resize', startWhenLandscape);
          window.removeEventListener('orientationchange', startWhenLandscape);
          showWhoModal();
        };
        window.addEventListener('resize', startWhenLandscape);
        window.addEventListener('orientationchange', startWhenLandscape);
      } else {
        showWhoModal();
      }
    })();
  </script>
</body>
</html>
